// src/test-engine/formulas/pf16.logic.ts

type Sexo = "M" | "F";
type Respuesta = "A" | "B" | "C";

const RESPUESTA_TO_INDICE: Record<Respuesta, number> = {
  A: 0,
  B: 1,
  C: 2,
};

// =============================================
// CLAVES DE PUNTUACIÓN POR PREGUNTA (TU TABLA)
// Cada pregunta tiene valores distintos para A,B,C
// =============================================
const VALORES_RESPUESTAS: Record<number, [number, number, number]> = {
  0: [0, 0, 0], 1: [0, 0, 0], 2: [0, 0, 0],
  3: [2, 1, 0], 4: [2, 1, 0], 5: [0, 1, 2], 6: [0, 1, 2], 7: [2, 1, 0],
  8: [0, 1, 2], 9: [0, 1, 2], 10: [2, 1, 0], 11: [0, 1, 2], 12: [2, 1, 0],
  13: [0, 1, 2], 14: [0, 1, 2], 15: [0, 1, 2], 16: [0, 1, 2], 17: [2, 1, 0],
  18: [0, 1, 2], 19: [0, 1, 2], 20: [2, 1, 0], 21: [0, 1, 2], 22: [0, 1, 2],
  23: [0, 1, 2], 24: [0, 1, 2], 25: [0, 1, 2], 26: [0, 1, 2], 27: [0, 0, 0],
  28: [0, 1, 0], 29: [0, 1, 2], 30: [2, 1, 0], 31: [0, 1, 2], 32: [0, 1, 2],
  33: [2, 1, 0], 34: [0, 1, 2], 35: [0, 1, 2], 36: [2, 1, 0], 37: [2, 1, 0],
  38: [2, 1, 0], 39: [2, 1, 0], 40: [2, 1, 0], 41: [0, 1, 2], 42: [2, 1, 0],
  43: [2, 1, 0], 44: [2, 1, 0], 45: [0, 1, 2], 46: [2, 1, 0], 47: [2, 1, 0],
  48: [2, 1, 0], 49: [0, 0, 0], 50: [2, 1, 0], 51: [0, 1, 2], 52: [2, 1, 0],
  53: [0, 1, 0], 54: [0, 1, 0], 55: [2, 1, 0], 56: [2, 1, 0], 57: [0, 1, 2],
  58: [2, 1, 0], 59: [0, 1, 2], 60: [0, 1, 2], 61: [0, 1, 2], 62: [0, 1, 2],
  63: [0, 1, 2], 64: [0, 1, 2], 65: [2, 1, 0], 66: [0, 1, 2], 67: [0, 1, 2],
  68: [2, 1, 0], 69: [0, 1, 2], 70: [2, 1, 0], 71: [2, 1, 0], 72: [2, 1, 0],
  73: [2, 1, 0], 74: [2, 1, 0], 75: [0, 1, 2], 76: [0, 1, 2], 77: [0, 0, 1],
  78: [0, 1, 0], 79: [0, 1, 2], 80: [0, 1, 2], 81: [0, 1, 2], 82: [0, 1, 2],
  83: [2, 1, 0], 84: [0, 1, 2], 85: [0, 1, 2], 86: [0, 1, 2], 87: [0, 1, 2],
  88: [2, 1, 0], 89: [0, 1, 2], 90: [0, 1, 2], 91: [2, 1, 0], 92: [0, 1, 2],
  93: [2, 1, 0], 94: [2, 1, 0], 95: [0, 1, 2], 96: [0, 1, 2], 97: [0, 1, 2],
  98: [2, 1, 0], 99: [2, 1, 0], 100: [0, 1, 2], 101: [2, 1, 0], 102: [0, 0, 1],
  103: [0, 1, 0], 104: [2, 1, 0], 105: [2, 1, 0], 106: [2, 1, 0], 107: [0, 1, 2],
  108: [0, 1, 2], 109: [2, 1, 0], 110: [2, 1, 0], 111: [2, 1, 0], 112: [2, 1, 0],
  113: [2, 1, 0], 114: [2, 1, 0], 115: [2, 1, 0], 116: [2, 1, 0], 117: [2, 1, 0],
  118: [2, 1, 0], 119: [2, 1, 0], 120: [0, 1, 2], 121: [0, 1, 2], 122: [0, 1, 2],
  123: [0, 1, 2], 124: [2, 1, 0], 125: [0, 1, 2], 126: [2, 1, 0], 127: [0, 0, 1],
  128: [0, 1, 0], 129: [0, 1, 2], 130: [2, 1, 0], 131: [2, 1, 0], 132: [2, 1, 0],
  133: [2, 1, 0], 134: [2, 1, 0], 135: [2, 1, 0], 136: [2, 1, 0], 137: [0, 1, 2],
  138: [2, 1, 0], 139: [0, 1, 2], 140: [2, 1, 0], 141: [0, 1, 2], 142: [2, 1, 0],
  143: [2, 1, 0], 144: [0, 1, 2], 145: [2, 1, 0], 146: [2, 1, 0], 147: [0, 1, 2],
  148: [2, 1, 0], 149: [2, 1, 0], 150: [0, 1, 2], 151: [0, 1, 2], 152: [1, 0, 0],
  153: [0, 0, 1], 154: [0, 1, 2], 155: [2, 1, 0], 156: [2, 1, 0], 157: [0, 1, 2],
  158: [0, 1, 2], 159: [0, 1, 2], 160: [2, 1, 0], 161: [0, 1, 2], 162: [0, 1, 2],
  163: [2, 1, 0], 164: [2, 1, 0], 165: [0, 1, 2], 166: [0, 1, 2], 167: [2, 1, 0],
  168: [0, 1, 2], 169: [2, 1, 0], 170: [0, 1, 2], 171: [2, 1, 0], 172: [0, 1, 2],
  173: [2, 1, 0], 174: [2, 1, 0], 175: [0, 1, 2], 176: [2, 1, 0], 177: [1, 0, 0],
  178: [1, 0, 0], 179: [2, 1, 0], 180: [2, 1, 0], 181: [2, 1, 0], 182: [2, 1, 0],
  183: [2, 1, 0], 184: [2, 1, 0], 185: [2, 1, 0], 186: [2, 1, 0],
};

// =============================================
// FACTORES Y PREGUNTAS (TU CONFIG)
// columna = indice en la matriz (1..16)
// =============================================
const FACTORES: Record<string, { preguntas: number[]; columna: number }> = {
  A: { preguntas: [3, 26, 51, 52, 76, 101, 126, 151, 176], columna: 1 },
  B: { preguntas: [28, 53, 54, 77, 78, 102, 103, 127, 128, 152, 153, 177, 178], columna: 2 },
  C: { preguntas: [4, 5, 29, 30, 55, 79, 80, 104, 105, 129, 130, 154, 179], columna: 3 },
  E: { preguntas: [6, 7, 31, 32, 56, 57, 81, 106, 131, 155, 156, 180, 181], columna: 4 },
  F: { preguntas: [8, 33, 58, 82, 83, 107, 108, 132, 133, 157, 158, 182, 183], columna: 5 },
  G: { preguntas: [9, 34, 59, 84, 109, 134, 159, 160, 184, 185], columna: 6 },
  H: { preguntas: [10, 35, 36, 60, 61, 85, 86, 110, 111, 135, 136, 161, 186], columna: 7 },
  I: { preguntas: [11, 12, 37, 62, 87, 112, 137, 138, 162, 163], columna: 8 },
  L: { preguntas: [13, 38, 63, 64, 88, 89, 113, 114, 139, 164], columna: 9 },
  M: { preguntas: [14, 15, 39, 40, 65, 90, 91, 115, 116, 140, 141, 165, 166], columna: 10 },
  N: { preguntas: [16, 17, 41, 42, 66, 67, 92, 117, 142, 167], columna: 11 },
  O: { preguntas: [18, 19, 43, 44, 68, 69, 93, 94, 118, 119, 143, 144, 168], columna: 12 },
  Q1: { preguntas: [20, 21, 45, 46, 70, 95, 120, 145, 169, 170], columna: 13 },
  Q2: { preguntas: [22, 47, 71, 72, 96, 97, 121, 122, 146, 171], columna: 14 },
  Q3: { preguntas: [23, 24, 48, 73, 98, 123, 147, 148, 172, 173], columna: 15 },
  Q4: { preguntas: [25, 49, 50, 74, 75, 99, 100, 124, 125, 149, 150, 174, 175], columna: 16 },
};

// =============================================
// MATRICES (TU TABLA) - PEGARLAS COMPLETAS
// =============================================

const MATRIZ_HOMBRES: number[][] = [
  [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
  [2, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 2],
  [3, 1, 3, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 3],
  [4, 2, 3, 1, 1, 1, 1, 1, 3, 3, 1, 1, 2, 1, 2, 1, 4],
  [5, 2, 4, 1, 1, 2, 1, 1, 4, 3, 1, 1, 2, 2, 2, 1, 4],
  [6, 3, 5, 1, 2, 2, 1, 1, 5, 4, 1, 2, 3, 2, 3, 2, 5],
  [7, 3, 6, 1, 3, 3, 1, 2, 5, 4, 2, 3, 4, 3, 3, 2, 5],
  [8, 4, 7, 1, 4, 3, 1, 3, 6, 5, 3, 3, 5, 4, 4, 2, 6],
  [9, 5, 9, 1, 4, 4, 2, 3, 6, 5, 3, 4, 5, 4, 5, 3, 6],
  [10, 5, 10, 2, 5, 4, 3, 3, 7, 6, 4, 4, 5, 5, 5, 3, 7],
  [11, 6, 10, 2, 5, 5, 3, 4, 8, 7, 5, 5, 6, 6, 6, 4, 7],
  [12, 6, 10, 2, 6, 5, 4, 4, 8, 7, 5, 6, 7, 6, 6, 4, 8],
  [13, 7, 10, 3, 6, 5, 5, 4, 9, 8, 6, 7, 7, 7, 7, 5, 8],
  [14, 8, 0, 3, 7, 6, 5, 5, 10, 8, 6, 7, 8, 7, 8, 6, 9],
  [15, 8, 0, 4, 7, 6, 6, 5, 10, 9, 7, 8, 8, 8, 8, 6, 9],
  [16, 9, 0, 4, 8, 7, 6, 5, 10, 10, 7, 9, 9, 9, 9, 7, 9],
  [17, 9, 0, 4, 8, 7, 7, 5, 10, 10, 8, 9, 9, 10, 9, 8, 10],
  [18, 10, 0, 5, 8, 8, 8, 6, 10, 10, 9, 10, 9, 10, 10, 9, 10],
  [19, 10, 0, 5, 9, 8, 9, 6, 10, 10, 10, 10, 10, 10, 10, 10, 10],
  [20, 10, 0, 6, 9, 8, 20, 7, 10, 10, 10, 10, 10, 10, 0, 10, 10],
  [21, 0, 0, 6, 10, 9, 0, 7, 0, 0, 10, 0, 10, 0, 0, 0, 0],
  [22, 0, 0, 7, 10, 9, 0, 7, 0, 0, 10, 0, 10, 0, 0, 0, 0],
  [23, 0, 0, 7, 10, 10, 0, 8, 0, 0, 10, 0, 10, 0, 0, 0, 0],
  [24, 0, 0, 8, 10, 10, 0, 8, 0, 0, 10, 0, 10, 0, 0, 0, 0],
  [25, 0, 0, 9, 10, 10, 0, 9, 0, 0, 10, 0, 10, 0, 0, 0, 0],
  [26, 0, 0, 10, 10, 10, 0, 10, 0, 0, 10, 0, 10, 0, 0, 0, 0],
];

const MATRIZ_MUJERES: number[][] = [
  [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
  [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1],
  [3, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 2],
  [4, 1, 5, 1, 1, 2, 1, 1, 2, 1, 1, 1, 3, 2, 1, 1, 3],
  [5, 1, 6, 1, 2, 2, 1, 1, 2, 2, 1, 1, 3, 2, 1, 2, 4],
  [6, 2, 7, 1, 3, 2, 1, 2, 3, 3, 1, 2, 4, 3, 2, 2, 4],
  [7, 3, 8, 1, 4, 3, 1, 2, 7, 4, 2, 2, 4, 3, 3, 3, 5],
  [8, 3, 9, 1, 4, 3, 2, 3, 5, 5, 2, 3, 4, 4, 3, 3, 5],
  [9, 4, 10, 1, 5, 4, 3, 3, 5, 6, 3, 4, 5, 4, 4, 3, 6],
  [10, 5, 10, 1, 5, 4, 4, 4, 5, 6, 4, 5, 5, 5, 5, 4, 6],
  [11, 5, 10, 1, 6, 5, 4, 4, 6, 6, 5, 6, 6, 5, 5, 4, 7],
  [12, 6, 10, 1, 6, 5, 5, 4, 6, 6, 5, 6, 7, 6, 6, 5, 7],
  [13, 7, 10, 2, 7, 6, 5, 5, 7, 7, 5, 7, 7, 7, 7, 6, 8],
  [14, 8, 0, 3, 7, 6, 6, 5, 7, 7, 6, 8, 8, 7, 7, 6, 8],
  [15, 9, 0, 4, 8, 7, 6, 6, 8, 8, 6, 9, 9, 8, 8, 6, 8],
  [16, 10, 0, 4, 8, 7, 7, 6, 9, 9, 7, 10, 9, 9, 8, 7, 9],
  [17, 10, 0, 4, 9, 8, 8, 7, 10, 10, 8, 10, 10, 10, 9, 8, 9],
  [18, 10, 0, 5, 10, 9, 9, 7, 10, 10, 8, 10, 10, 10, 10, 9, 10],
  [19, 10, 0, 5, 10, 9, 10, 7, 10, 10, 9, 10, 10, 10, 10, 10, 10],
  [20, 10, 0, 6, 10, 9, 10, 7, 10, 10, 9, 10, 10, 10, 10, 10, 10],
  [21, 0, 0, 7, 10, 9, 0, 8, 0, 0, 10, 0, 10, 10, 0, 0, 10],
  [22, 0, 0, 7, 10, 10, 0, 8, 0, 0, 10, 0, 10, 10, 0, 0, 10],
  [23, 0, 0, 8, 10, 10, 0, 8, 0, 0, 10, 0, 10, 10, 0, 0, 10],
  [24, 0, 0, 9, 10, 10, 0, 9, 0, 0, 10, 0, 10, 10, 0, 0, 10],
  [25, 0, 0, 9, 10, 10, 0, 10, 0, 0, 10, 0, 10, 10, 0, 0, 10],
  [26, 0, 0, 10, 10, 10, 0, 10, 0, 0, 10, 0, 10, 10, 0, 0, 10],
];

// =============================================
// HELPERS
// =============================================

function validarRespuestas(answers: Record<string, string>) {
  for (let i = 1; i <= 186; i++) {
    const key = `q${i}`;
    const valor = answers[key];

    if (!valor) {
      throw new Error(`Falta la respuesta de la pregunta ${i}`);
    }

    if (valor !== "A" && valor !== "B" && valor !== "C") {
      throw new Error(`Respuesta inválida en pregunta ${i}. Solo se permite A, B o C`);
    }
  }
}

function calcularPuntajePregunta(numPregunta: number, respuesta: Respuesta): number {
  const valores = VALORES_RESPUESTAS[numPregunta];

  if (!valores) {
    throw new Error(`No existe clave de valores para la pregunta ${numPregunta}`);
  }

  const indice = RESPUESTA_TO_INDICE[respuesta];
  return valores[indice];
}

function obtenerDecatipo(matriz: number[][], suma: number, columna: number): number {
  const min = matriz[0][0];
  const max = matriz[matriz.length - 1][0];

  const sumaAjustada = Math.max(min, Math.min(max, suma));

  for (const fila of matriz) {
    if (fila[0] === sumaAjustada) {
      return fila[columna] ?? 0;
    }
  }

  return 0;
}

// =============================================
// FUNCIÓN PRINCIPAL
// =============================================

export const calculate16PF = (answers: Record<string, string>, sexo: Sexo) => {
  validarRespuestas(answers);

  // 1. Puntajes brutos
  const puntajesBrutos: Record<string, number> = {};

  for (const [factor, config] of Object.entries(FACTORES)) {
    let suma = 0;

    for (const numPregunta of config.preguntas) {
      const respuesta = answers[`q${numPregunta}`] as Respuesta;
      suma += calcularPuntajePregunta(numPregunta, respuesta);
    }

    puntajesBrutos[factor] = suma;
  }

  // 2. Convertir a decatipos
  const matriz = sexo === "M" ? MATRIZ_HOMBRES : MATRIZ_MUJERES;
  const decatipos: Record<string, number> = {};

  for (const [factor, config] of Object.entries(FACTORES)) {
    const suma = puntajesBrutos[factor];
    decatipos[factor] = obtenerDecatipo(matriz, suma, config.columna);
  }

  // 3. Resultado final estilo MOSS
  return {
    puntajesBrutos,
    decatipos,
  };
};
